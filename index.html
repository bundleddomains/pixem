<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy"
content="
default-src 'self';
img-src 'self' data: blob:;
style-src 'self' 'unsafe-inline';
script-src 'self';
base-uri 'none';
object-src 'none';
frame-ancestors 'none';
">
<title>Rat Layout Tool</title>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:monospace;color:#0f0;}
.rat{position:absolute;cursor:grab;user-select:none;touch-action:none;}
.panel{position:fixed;bottom:20px;left:20px;background:#111;border:1px solid #333;padding:12px;width:320px;}
textarea{width:100%;height:110px;background:#000;color:#0f0;border:1px solid #333;}
button,input{margin-top:6px;width:100%;background:#000;color:#0f0;border:1px solid #333;padding:6px;}
</style>
</head>
<body>

<div class="panel">
  <input type="file" id="imageInput" accept="image/png,image/jpeg,image/webp,image/gif">
  Layout JSON
  <textarea id="layoutData" spellcheck="false"></textarea>
  <button id="exportBtn">Export</button>
  <button id="importBtn">Import</button>
</div>

<script>
let highestZ = 1;
let imageCounter = 0;

function makeDraggable(el){
  let offsetX, offsetY;

  function start(e){
    e.preventDefault();
    el.style.zIndex = ++highestZ;

    const rect = el.getBoundingClientRect();
    const pt = e.touches ? e.touches[0] : e;
    offsetX = pt.clientX - rect.left;
    offsetY = pt.clientY - rect.top;

    document.addEventListener("mousemove", move);
    document.addEventListener("touchmove", move, {passive:false});
    document.addEventListener("mouseup", stop, {once:true});
    document.addEventListener("touchend", stop, {once:true});
  }

  function move(e){
    e.preventDefault();
    const pt = e.touches ? e.touches[0] : e;
    el.style.left = (pt.clientX - offsetX) + "px";
    el.style.top  = (pt.clientY - offsetY) + "px";
  }

  function stop(){
    document.removeEventListener("mousemove", move);
    document.removeEventListener("touchmove", move);
  }

  el.addEventListener("mousedown", start);
  el.addEventListener("touchstart", start, {passive:false});
}

function addImageFromDataURL(dataURL){
  const img = document.createElement("img");
  img.src = dataURL;
  img.className = "rat";
  img.dataset.id = "img" + (imageCounter++);
  img.style.top = "150px";
  img.style.left = "150px";
  img.style.width = "220px";
  img.style.zIndex = ++highestZ;

  document.body.appendChild(img);
  makeDraggable(img);
}

document.getElementById("imageInput").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  // hard reject svg
  if(file.type === "image/svg+xml" || file.name.toLowerCase().endsWith(".svg")){
    alert("SVG blocked for safety. Use PNG/JPG/WebP/GIF.");
    e.target.value = "";
    return;
  }

  const reader = new FileReader();
  reader.onload = (ev)=> addImageFromDataURL(ev.target.result);
  reader.readAsDataURL(file);

  e.target.value = "";
});

function exportLayout(){
  const data = [];
  document.querySelectorAll(".rat").forEach(el=>{
    data.push({
      id: el.dataset.id,
      src: el.src,             // data URL
      top: el.style.top,
      left: el.style.left,
      width: el.style.width,
      z: Number(el.style.zIndex || 1)
    });
  });
  document.getElementById("layoutData").value = JSON.stringify(data, null, 2);
}

function importLayout(){
  const input = document.getElementById("layoutData").value;
  let data;
  try{ data = JSON.parse(input); } catch { alert("Invalid JSON"); return; }

  // clear existing
  document.querySelectorAll(".rat").forEach(el=> el.remove());

  // rebuild
  data.forEach(item=>{
    // only allow data: images (no remote URLs)
    if(typeof item.src !== "string" || !item.src.startsWith("data:image/")){
      return;
    }
    const img = document.createElement("img");
    img.src = item.src;
    img.className = "rat";
    img.dataset.id = item.id;
    img.style.top = item.top;
    img.style.left = item.left;
    img.style.width = item.width;
    img.style.zIndex = String(item.z || 1);

    document.body.appendChild(img);
    makeDraggable(img);
    highestZ = Math.max(highestZ, Number(item.z || 1));
  });
}

document.getElementById("exportBtn").addEventListener("click", exportLayout);
document.getElementById("importBtn").addEventListener("click", importLayout);
</script>

</body>
</html>
