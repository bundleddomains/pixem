<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width, initial-scale=1.0,
maximum-scale=1.0, user-scalable=no">

<title>Rat Luhv Layout Tool</title>

<style>
html, body{
  margin:0;
  background:#000;
  overflow:hidden;
  font-family:monospace;
  color:#0f0;
  touch-action:none;
}

.rat{
  position:absolute;
  cursor:grab;
  user-select:none;
  touch-action:none;
}

.panel{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#111;
  border:1px solid #333;
  padding:12px;
  width:320px;
  z-index:9999;
}

textarea{
  width:100%;
  height:110px;
  background:#000;
  color:#0f0;
  border:1px solid #333;
}

button,input{
  margin-top:6px;
  width:100%;
  background:#000;
  color:#0f0;
  border:1px solid #333;
  padding:6px;
}

.watermark{
  position:fixed;
  top:20px;
  right:20px;
  color:#0f0;
  opacity:0.15;
  font-size:22px;
  pointer-events:none;
  letter-spacing:4px;
}
</style>
</head>
<body>

<div class="watermark">RAT LUHV</div>

<div class="panel">
  <input type="file" id="imageInput" accept="image/png,image/jpeg,image/webp,image/gif">
  Layout JSON
  <textarea id="layoutData" spellcheck="false"></textarea>
  <button id="exportBtn">Export</button>
  <button id="importBtn">Import</button>
</div>

<script>

let highestZ = 1;
let imageCounter = 0;

function makeInteractive(el){

  let offsetX, offsetY;
  let startDistance = 0;
  let startWidth = 0;

  function getDistance(touches){
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx*dx + dy*dy);
  }

  function start(e){
    el.style.zIndex = ++highestZ;

    if(e.touches && e.touches.length === 2){
      startDistance = getDistance(e.touches);
      startWidth = el.offsetWidth;
      return;
    }

    const pt = e.touches ? e.touches[0] : e;
    const rect = el.getBoundingClientRect();
    offsetX = pt.clientX - rect.left;
    offsetY = pt.clientY - rect.top;

    document.addEventListener("mousemove", move);
    document.addEventListener("touchmove", move, {passive:false});
    document.addEventListener("mouseup", stop, {once:true});
    document.addEventListener("touchend", stop, {once:true});
  }

  function move(e){

    if(e.touches && e.touches.length === 2){
      e.preventDefault();
      const newDistance = getDistance(e.touches);
      const scale = newDistance / startDistance;
      const newWidth = startWidth * scale;
      if(newWidth > 30){
        el.style.width = newWidth + "px";
      }
      return;
    }

    const pt = e.touches ? e.touches[0] : e;
    el.style.left = (pt.clientX - offsetX) + "px";
    el.style.top  = (pt.clientY - offsetY) + "px";
  }

  function stop(){
    document.removeEventListener("mousemove", move);
    document.removeEventListener("touchmove", move);
  }

  el.addEventListener("mousedown", start);
  el.addEventListener("touchstart", start, {passive:false});

  el.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const delta = e.deltaY * -0.01;
    const newWidth = el.offsetWidth * (1 + delta);
    if(newWidth > 30){
      el.style.width = newWidth + "px";
    }
  });
}

function addImage(dataURL){
  const img = document.createElement("img");
  img.src = dataURL;
  img.className = "rat";
  img.dataset.id = "img" + (imageCounter++);
  img.style.top = "150px";
  img.style.left = "150px";
  img.style.width = "220px";
  img.style.zIndex = ++highestZ;

  document.body.appendChild(img);
  makeInteractive(img);
}

document.getElementById("imageInput").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  if(file.type === "image/svg+xml"){
    alert("SVG blocked.");
    return;
  }

  const reader = new FileReader();
  reader.onload = (ev)=> addImage(ev.target.result);
  reader.readAsDataURL(file);
  e.target.value = "";
});

function exportLayout(){
  const data = [];
  document.querySelectorAll(".rat").forEach(el=>{
    data.push({
      id: el.dataset.id,
      src: el.src,
      top: el.style.top,
      left: el.style.left,
      width: el.style.width,
      z: Number(el.style.zIndex || 1)
    });
  });
  document.getElementById("layoutData").value =
    JSON.stringify(data, null, 2);
}

function importLayout(){
  const input = document.getElementById("layoutData").value;
  let data;
  try{ data = JSON.parse(input); }
  catch { alert("Invalid JSON"); return; }

  document.querySelectorAll(".rat").forEach(el=> el.remove());

  data.forEach(item=>{
    if(!item.src.startsWith("data:image/")) return;

    const img = document.createElement("img");
    img.src = item.src;
    img.className = "rat";
    img.dataset.id = item.id;
    img.style.top = item.top;
    img.style.left = item.left;
    img.style.width = item.width;
    img.style.zIndex = item.z;

    document.body.appendChild(img);
    makeInteractive(img);
    highestZ = Math.max(highestZ, item.z);
  });
}

document.getElementById("exportBtn").addEventListener("click", exportLayout);
document.getElementById("importBtn").addEventListener("click", importLayout);

</script>

</body>
</html>
